#!/usr/bin/make -f
# -*- makefile -*-

include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/makefile.mk
include /usr/share/cdbs/1/rules/utils.mk

EPICS_HOST_ARCH:=$(shell ./startup/EpicsHostArch)

# chop out the source version from Changelog (ie 3.14.10)
SOV=$(shell echo "$(DEB_NOEPOCH_VERSION)"| cut -f 1 -d '-')

RTEMS_TARGETS=RTEMS-mvme2100 RTEMS-mvme3100 RTEMS-mvme5500 RTEMS-pc386
DEBUG_TAGETS=$(EPICS_HOST_ARCH)-debug
TARGETS+=$(DEBUG_TAGETS) $(RTEMS_TARGETS)

DEB_MAKE_ENVVARS = PATH="$(CURDIR)/bin/$(EPICS_HOST_ARCH):$$PATH" \
LD_LIBRARY_PATH="$(CURDIR)/lib/$(EPICS_HOST_ARCH):$$LD_LIBRARY_PATH"

DEB_MAKE_MAKEVARS = EPICS_HOST_ARCH=$(EPICS_HOST_ARCH) USE_RPATH=NO \
CROSS_COMPILER_TARGET_ARCHS="$(TARGETS)" \
ABS_INSTALL_DIR=/usr/epics/base

# Prevent CFLAGS and similar from being passed to EPICS since
# this will break cross-builds of things.
DEB_MAKE_INVOKE  = $(DEB_MAKE_ENVVARS) $(MAKE) -C $(DEB_BUILDDIR) $(DEB_MAKE_MAKEVARS)

DEB_MAKE_CLEAN_TARGET = distclean
DEB_MAKE_BUILD_TARGET = all
DEB_MAKE_INSTALL_TARGET = all INSTALL_LOCATION=$(CURDIR)/debian/tmp/usr/epics/base
DEB_MAKE_CHECK_TARGET =

# prevent debug and cross targets from being stripped
DEB_DH_STRIP_ARGS := -Xdebug -XRTEMS

epics_libs+= asHost asIoc ca cas Com
epics_libs+= dbIoc dbStaticHost dbStaticIoc dbtoolsIoc
epics_libs+= gdd miscIoc recIoc registryIoc
epics_libs+= rsrvIoc softDevIoc testDevIoc

# lib*.so.3.14.10
epics_libfiles = $(patsubst %,debian/tmp/usr/epics/base/lib/$(EPICS_HOST_ARCH)/lib%.so.$(SOV),$(epics_libs))
# lib*.so
epics_linklib  = $(patsubst %,debian/tmp/usr/epics/base/lib/$(EPICS_HOST_ARCH)/lib%.so,$(epics_libs))

# Copy host sonamed libraries to /usr/lib
# Leave a symlink in /usr/epics/base/lib/$EPICS_HOST_ARCH
install/epics-libs::
	install -d $(CURDIR)/debian/tmp/usr/lib
	mv -t $(CURDIR)/debian/tmp/usr/lib $(epics_libfiles)
	for ff in $(epics_linklib); do rm -f $$ff; ln -s ../../../../lib/`basename $$ff`.$(SOV) $$ff; done

epics_perllib  = debian/tmp/usr/epics/base/lib/$(EPICS_HOST_ARCH)/libCap5.so

install/epics-perl::
	install -d $(CURDIR)/debian/tmp/usr/lib
	mv -t $(CURDIR)/debian/tmp/usr/lib $(epics_perllib)
	mv $(CURDIR)/debian/tmp/usr/epics/base/lib/perl $(CURDIR)/debian/tmp/usr/lib/perl5

epics_utils+= caget cainfo camonitor caput casw caRepeater
#epics_utils+= iocLogServer softIoc

epics_bins = $(patsubst %,debian/tmp/usr/epics/base/bin/$(EPICS_HOST_ARCH)/%,$(epics_utils))

# Move some utilities to /usr/bin
# Leave a symlink in /usr/epics/base/bin/$EPICS_HOST_ARCH
install/epics-catools::
	install -d $(CURDIR)/debian/tmp/usr/bin
	mv -t $(CURDIR)/debian/tmp/usr/bin $(epics_bins)
	for ff in $(epics_bins); do rm -f $$ff; ln -s ../../../../bin/`basename $$ff` $$ff; done

install/epics-compat-dev::
	install -d $(CURDIR)/debian/tmp/usr/epics/base
	cp -r $(CURDIR)/config $(CURDIR)/debian/tmp/usr/epics/base/

clean::
	@echo "DEB_VERSION: $(DEB_VERSION)"
	@echo "DEB_NOEPOCH_VERSION: $(DEB_NOEPOCH_VERSION)"
	@echo "SOVERSON: $(SOV)"
