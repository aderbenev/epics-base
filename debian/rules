#!/usr/bin/make -f
# -*- makefile -*-

export DH_VERBOSE=1

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
BMAKEFLAGS += -j$(NUMJOBS)
endif

EPICS_HOST_ARCH:=$(shell ./startup/EpicsHostArch)

# chop out the source version from Changelog (ie 3.14.11)
# Taken from CDBS
DEB_VERSION = $(shell dpkg-parsechangelog | egrep '^Version:' | cut -f 2 -d ' ')
DEB_NOEPOCH_VERSION = $(shell echo $(DEB_VERSION) | cut -d: -f2-)
SOV=$(shell echo "$(DEB_NOEPOCH_VERSION)"| cut -f 1 -d '-')

RTEMS_TARGETS += RTEMS-mvme2100
RTEMS_TARGETS += RTEMS-mvme2307
RTEMS_TARGETS += RTEMS-mvme3100
RTEMS_TARGETS += RTEMS-mvme5500
RTEMS_TARGETS += RTEMS-pc386
TARGETS+=$(RTEMS_TARGETS)

# Since we are disabling RPATH this is needed to ensure that
# we don't accidentally pick up things from other versions
# of Base installed on the build host
DEB_MAKE_ENVVARS += PATH="$(CURDIR)/bin/$(EPICS_HOST_ARCH):$$PATH"
DEB_MAKE_ENVVARS += LD_LIBRARY_PATH="$(CURDIR)/lib/$(EPICS_HOST_ARCH):$$LD_LIBRARY_PATH"

DEB_MAKE_MAKEVARS += EPICS_HOST_ARCH=$(EPICS_HOST_ARCH)
DEB_MAKE_MAKEVARS += USE_RPATH=NO
DEB_MAKE_MAKEVARS += CROSS_COMPILER_TARGET_ARCHS="$(TARGETS)"
# ABS_INSTALL_DIR is used in the 'softIoc' executable
DEB_MAKE_MAKEVARS += ABS_INSTALL_DIR=/usr/epics/base

# Prevent CFLAGS and similar from being passed to EPICS since
# this will break cross-builds of things.
DEB_MAKE_INVOKE  = $(DEB_MAKE_ENVVARS) $(MAKE) $(DEB_MAKE_MAKEVARS)

build: build-stamp

build-stamp:
	dh build --before configure

	$(DEB_MAKE_INVOKE) $(BMAKEFLAGS) all

	dh build --after auto_build

	touch $@

clean:
	dh clean --before auto_clean

	$(DEB_MAKE_INVOKE) distclean

	dh clean --after auto_clean

prefix=debian/tmp/usr
epicsbase=$(prefix)/epics/base

epicsbin=$(epicsbase)/bin/$(EPICS_HOST_ARCH)
epicslib=$(epicsbase)/lib/$(EPICS_HOST_ARCH)

## Utilities

epics_bins = $(patsubst %,debian/tmp/usr/epics/base/bin/$(EPICS_HOST_ARCH)/%,$(epics_utils))

install: build
	# Why is install trying to re-run build???
	dh install --before auto_install --with rtems

	$(DEB_MAKE_INVOKE) $(BMAKEFLAGS) all INSTALL_LOCATION=$(CURDIR)/debian/tmp/usr/epics/base

	rm -rf $(CURDIR)/debian/tmp/usr/epics/base/bin/$(EPICS_HOST_ARCH)
	rm -rf $(CURDIR)/debian/tmp/usr/epics/base/lib/$(EPICS_HOST_ARCH)
	rm -rf $(CURDIR)/debian/tmp/usr/epics/base/lib/perl
	rm -rf $(CURDIR)/debian/tmp/usr/epics/base/configure
	rm -rf $(CURDIR)/debian/tmp/usr/epics/base/db*
	rm -rf $(CURDIR)/debian/tmp/usr/epics/base/html
	rm -rf $(CURDIR)/debian/tmp/usr/epics/base/startup
	rm -rf $(CURDIR)/debian/tmp/usr/epics/base/templates
	rm -f $(CURDIR)/debian/tmp/usr/epics/base/include/*.*
	rm -rf $(CURDIR)/debian/tmp/usr/epics/base/include/os/Linux

	dh install --after auto_install --before dh_install --with rtems

	dh_install --fail-missing

	dh install --after dh_install --before dh_installdocs --with rtems

	dh_installdocs -A README

	dh install --after dh_installdocs --with rtems

binary-arch: install
	dh binary-arch --with rtems

binary-indep: install
	dh binary-indep

binary: binary-arch binary-indep
